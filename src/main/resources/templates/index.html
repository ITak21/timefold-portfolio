<!doctype html><html lang="ko" xmlns:th="http://www.thymeleaf.org"><head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>M60→M1440 Demo</title>

    <!-- 기본 스타일 -->
    <style>
        body{font-family:system-ui,Arial;padding:24px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:8px}
        th{background:#f5f5f5;text-align:left}
    </style>

    <!-- 토스트/스피너 -->
    <style>
        .toast-wrap{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
        .toast{
          min-width:260px; max-width:420px; padding:12px 14px; border-radius:8px;
          box-shadow:0 6px 20px rgba(0,0,0,0.15); color:#fff; background:#333; opacity:0.95;
          font-size:14px; line-height:1.3;
        }
        .toast.ok{background:#2e7d32}
        .toast.err{background:#c62828}
        .toast.info{background:#1565c0}
        button[disabled]{opacity:0.6; cursor:not-allowed}
        .spinner{display:inline-block; width:14px; height:14px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:-2px; margin-right:6px}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<h1>M60 → M1440 데모</h1>

<!-- 시드/집계 -->
<h2>데이터 생성 · 집계</h2>
<div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
    <label>Day</label><input type="date" id="seedDay" required>

    <label>groups/h</label><input type="number" id="seedGroups" value="100000" min="1" style="width:110px">
    <label>keys</label><input type="number" id="seedKeys" value="3" min="1" max="20" style="width:70px">
    <label>batch</label><input type="number" id="seedBatch" value="1000" min="100" style="width:90px">

    <button type="button" id="btnSeed" onclick="seed()">시드 생성</button>
    <button type="button" id="btnAgg" onclick="aggregate()">집계 실행</button>
</div>
<p style="margin-top:12px">※ 처음에는 groups=1000으로 빠르게 검증 후 100000으로 올리세요.</p>

<hr>

<!-- 탐색/차트 -->
<h2>집계 결과 탐색</h2>
<form id="qf" onsubmit="return false;">
    <label>Day</label>
    <input type="date" id="qDay" required>

    <label>Element</label>
    <select id="qE"></select>

    <label>Measurement</label>
    <select id="qM"></select>

    <label>Source</label>
    <input id="qS" placeholder="검색(prefix), 예: store-000" />
    <button type="button" onclick="pickSource()">소스 탐색</button>

    <select id="qSList"></select>
    <button type="button" onclick="loadSeries()">선택 소스 차트</button>
    <button type="button" onclick="loadSeriesAvg()">전체 평균 차트</button>
</form>

<canvas id="chart" height="130" style="margin-top:8px"></canvas>

<div class="toast-wrap" id="toastWrap"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let chart;

    /* ===== 공통 유틸 ===== */
    function toast(msg, type='ok', ms=3000){
      const wrap = document.getElementById('toastWrap');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(8px)'; }, ms-500);
      setTimeout(()=> wrap.removeChild(t), ms);
    }

    async function fetchJson(url){
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }catch(e){
        toast(`요청 실패: ${e.message}`, 'err', 5000);
        throw e;
      }
    }

    async function postForm(url, params, btn){
      try{
        if(btn){
          btn.disabled = true;
          const old = btn.textContent;
          btn.dataset.old = old;
          btn.innerHTML = '<span class="spinner"></span>'+old;
        }
        const body = new URLSearchParams(params);
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const ok = res.ok;
        let data = {};
        try{ data = await res.json(); } catch(e){}
        if(ok) return data;
        throw new Error(data.message || `HTTP ${res.status}`);
      } finally {
        if(btn){
          btn.innerHTML = btn.dataset.old;
          btn.disabled = false;
        }
      }
    }

    /* ===== 탐색/차트 ===== */
    async function loadElements(){
      const day = document.getElementById('qDay').value;
      const es = await fetchJson(`/api/facets/elements?day=${day}`);
      const sel = document.getElementById('qE');
      sel.innerHTML = "";
      es.forEach(e => sel.append(new Option(e,e)));
      await loadMeasurements();
      document.getElementById('qSList').innerHTML = "";
    }

    async function loadMeasurements(){
      const day = document.getElementById('qDay').value;
      const e = document.getElementById('qE').value;
      const ms = await fetchJson(`/api/facets/measurements?day=${day}&element=${e}`);
      const sel = document.getElementById('qM');
      sel.innerHTML = "";
      ms.forEach(m => sel.append(new Option(`${m.measurement} (src:${m.sources})`, m.measurement)));
      document.getElementById('qSList').innerHTML = "";
    }

    async function pickSource(){
      const day = document.getElementById('qDay').value;
      const e = document.getElementById('qE').value;
      const m = document.getElementById('qM').value;
      const q = document.getElementById('qS').value;
      const list = await fetchJson(`/api/facets/sources?day=${day}&element=${e}&measurement=${m}&q=${encodeURIComponent(q)}&limit=50`);
      const sel = document.getElementById('qSList');
      sel.innerHTML = "";
      list.forEach(s => sel.append(new Option(s,s)));
    }

    async function loadSeries(){
      const day = document.getElementById('qDay').value;
      const e = document.getElementById('qE').value;
      const m = document.getElementById('qM').value;
      const sSel = document.getElementById('qSList');
      if(!sSel.value){ alert('Source를 선택하세요'); return; }
      const js = await fetchJson(`/api/d1/series?day=${day}&element=${e}&measurement=${m}&sourceId=${sSel.value}`);
      drawChart(js);
    }

    async function loadSeriesAvg(){
      const day = document.getElementById('qDay').value;
      const e = document.getElementById('qE').value;
      const m = document.getElementById('qM').value;
      const js = await fetchJson(`/api/d1/series-avg?day=${day}&element=${e}&measurement=${m}`);
      drawChart(js);
    }

    function drawChart(js){
      if(!js.ok){ alert('데이터 없음'); return; }
      const labels = Object.keys(js.data).sort();
      const values = labels.map(k=>js.data[k]);
      if(chart) chart.destroy();
      chart = new Chart(document.getElementById('chart'), {
        type:'bar',
        data:{ labels, datasets:[{ label: js.group, data: values }]},
        options:{ responsive:true, animation:false }
      });
    }

    /* ===== 시드/집계 핸들러 ===== */
    async function seed(){
      const day = document.getElementById('seedDay').value;
      if(!day){ alert('Day를 선택하세요'); return; }
      const groups = document.getElementById('seedGroups').value;
      const keys   = document.getElementById('seedKeys').value;
      const batch  = document.getElementById('seedBatch').value;

      const btn = document.getElementById('btnSeed');
      try{
        await postForm('/dev/seed', { day, groups, keysPerJson:keys, batchSize:batch }, btn);
        toast(`시드 완료: day=${day}, groups=${groups}`, 'ok');
        // 탐색 패널 갱신
        document.getElementById('qDay').value = day;
        await loadElements();
      }catch(err){
        toast(`시드 실패: ${err.message}`, 'err', 5000);
      }
    }

    async function aggregate(){
      const day = document.getElementById('seedDay').value;
      if(!day){ alert('Day를 선택하세요'); return; }
      const btn = document.getElementById('btnAgg');
      try{
        const r = await postForm('/dev/aggregate', { day }, btn);
        const n = (r && r.upserts!=null) ? r.upserts : '?';
        toast(`집계 완료: upserts=${n}`, 'info');
        // 탐색/차트 자동 갱신
        document.getElementById('qDay').value = day;
        await loadElements();
        await loadSeriesAvg();
      }catch(err){
        toast(`집계 실패: ${err.message}`, 'err', 5000);
      }
    }

    /* ===== 이벤트 바인딩 & 초기 로딩 ===== */
    document.getElementById('qE').addEventListener('change', async () => {
      await loadMeasurements();
      document.getElementById('qSList').innerHTML = "";
    });
    document.getElementById('qM').addEventListener('change', () => {
      document.getElementById('qSList').innerHTML = "";
    });
    document.getElementById('qS').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); pickSource(); }
    });
    document.getElementById('qDay').addEventListener('change', loadElements);

    document.addEventListener('DOMContentLoaded', async () => {
      const today = new Date().toISOString().slice(0,10);
      const seedDay = document.getElementById('seedDay');
      const qDay    = document.getElementById('qDay');
      if(!seedDay.value) seedDay.value = today;
      if(!qDay.value)    qDay.value    = today;
      await loadElements();
    });
</script>
</body></html>
